server {
  listen 443 ssl http2;
  listen [::]:443 ssl http2;
  server_name _;

  ssl_certificate     /etc/nginx/certs/fullchain.pem;
  ssl_certificate_key /etc/nginx/certs/privkey.pem;

  # FE static (Next export)
  root /usr/share/nginx/html;
  index index.html;
  client_max_body_size 20m;

  # FE
  location / {
    try_files $uri $uri/ /index.html;
  }

  # === Laravel API: chuyển thẳng vào php-fpm, GIỮ nguyên URI ===
  location ^~ /api/ {
    include       fastcgi_params;
    fastcgi_pass  laravel:9000;

    # ĐƯỜNG DẪN CHUẨN:
    fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
    fastcgi_param SCRIPT_NAME     /index.php;

    fastcgi_param QUERY_STRING    $query_string;
    fastcgi_param REQUEST_METHOD  $request_method;
    fastcgi_param CONTENT_TYPE    $content_type;
    fastcgi_param CONTENT_LENGTH  $content_length;
  }

  # === Laravel redirect short link /r/* ===
  location ^~ /r/ {
    include       fastcgi_params;
    fastcgi_pass  laravel:9000;

    fastcgi_param SCRIPT_FILENAME /var/www/html/public/index.php;
    fastcgi_param SCRIPT_NAME     /index.php;

    fastcgi_param QUERY_STRING    $query_string;
    fastcgi_param REQUEST_METHOD  $request_method;
    fastcgi_param CONTENT_TYPE    $content_type;
    fastcgi_param CONTENT_LENGTH  $content_length;
  }

  # (tuỳ chọn) public storage nếu có symlink
  location ^~ /storage/ {
    alias /var/www/html/public/storage/;
    try_files $uri =404;
  }

  add_header X-Frame-Options SAMEORIGIN;
  add_header X-Content-Type-Options nosniff;
}
